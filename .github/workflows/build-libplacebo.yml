name: Build libplacebo

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            triplet: x64-windows
            binary_ext: dll

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: haasn/libplacebo
          path: libplacebo

      - name: Install build tools
        shell: bash
        run: |
          case "$RUNNER_OS" in
          "Linux")
           sudo apt-get update -qq
           sudo apt-get install -y \
             build-essential meson ninja-build \
             libshaderc-dev vulkan-validationlayers-dev \
             liblcms2-dev libdovi-dev
           ;;
          "macOS")
           brew update
           brew install meson ninja shaderc vulkan-headers lcms2 libdovi
           ;;
          "Windows")
           choco install -y meson ninja python
           pip install meson
           # Install Vulkan SDK silently
           curl -LO https://sdk.lunarg.com/sdk/download/latest/windows/vulkan-sdk.exe
           ./vulkan-sdk.exe /S
           ;;
          esac

      - name: Configure static build
        shell: bash
        working-directory: ./libplacebo
        run: |
          meson setup build \
            --buildtype=release \
            --default-library=static \
            --prefix=/tmp/libplacebo-static \
            -Dshaderc=disabled \      
            -Dvulkan=disabled \       
            -Dlcms=disabled \         
            -Ddovi=disabled \         
            -Dglslang=disabled \      
            -Dopengl=disabled \       
            -Dd3d11=disabled          

      - name: Compile and install
        shell: bash
        working-directory: ./libplacebo
        run: |
          meson compile -C build
          meson install -C build

      - name: Package library
        shell: bash
        run: |
          cd /tmp/libplacebo-static
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            7z a libplacebo-static-${{ runner.os }}.zip ./*
          else
            tar czvf libplacebo-static-${{ runner.os }}.tar.gz ./*
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libplacebo-static-${{ runner.os }}
          path: /tmp/libplacebo-static/libplacebo-static-${{ runner.os }}.*